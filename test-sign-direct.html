<!DOCTYPE html>
<html>
<head>
    <title>Direct Backend Test - /sign API</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        button { padding: 10px 20px; margin: 10px 0; font-size: 16px; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        input { width: 400px; padding: 8px; margin: 5px 0; }
    </style>
</head>
<body>
    <h1>üîç Direct Backend Test - /sign API</h1>
    
    <div>
        <label>Invoice ID:</label><br>
        <input type="number" id="invoiceId" value="60" />
    </div>
    
    <div>
        <label>Authorization Token:</label><br>
        <input type="text" id="token" placeholder="Bearer token..." style="width: 600px;" />
    </div>
    
    <button onclick="testDirectSign()">üöÄ Test Direct Sign API</button>
    <button onclick="testSwagger()">üìñ Show Swagger Test Instructions</button>
    
    <h2>Results:</h2>
    <div id="results"></div>

    <script>
        // Auto-fill token from localStorage if available
        window.onload = () => {
            const savedToken = localStorage.getItem('token');
            if (savedToken) {
                document.getElementById('token').value = savedToken;
            }
        };

        async function testDirectSign() {
            const invoiceId = document.getElementById('invoiceId').value;
            const token = document.getElementById('token').value;
            const resultsDiv = document.getElementById('results');
            
            resultsDiv.innerHTML = '<p>‚è≥ Testing...</p>';
            
            try {
                console.clear();
                console.log('üîç === DIRECT BACKEND TEST ===');
                console.log('Invoice ID:', invoiceId);
                console.log('Token:', token ? 'Present' : 'Missing');
                
                // Test 1: Direct fetch (no axios, no nothing)
                resultsDiv.innerHTML += '<h3>Test 1: Direct Fetch API</h3>';
                
                // DIRECT TO BACKEND - NO PROXY!
                const response = await fetch(`http://159.223.64.31/api/Invoice/${invoiceId}/sign`, {
                    method: 'POST',
                    headers: {
                        'Authorization': token,
                        'Content-Type': 'application/json',
                        'Accept': '*/*'
                    },
                    body: JSON.stringify({})
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);
                
                const rawText = await response.text();
                console.log('Raw response text:', rawText);
                
                let data;
                try {
                    data = JSON.parse(rawText);
                    console.log('Parsed JSON:', data);
                } catch (e) {
                    console.error('Failed to parse JSON:', e);
                    throw new Error('Response is not valid JSON: ' + rawText);
                }
                
                resultsDiv.innerHTML += `
                    <pre class="success">‚úÖ Status: ${response.status}</pre>
                    <pre><strong>Raw Response Text:</strong>\n${rawText}</pre>
                    <pre><strong>Parsed JSON:</strong>\n${JSON.stringify(data, null, 2)}</pre>
                `;
                
                // Analyze invoice number
                if (data.invoiceNumber === null) {
                    resultsDiv.innerHTML += '<pre class="error">‚ùå Backend tr·∫£ v·ªÅ invoiceNumber = null</pre>';
                } else if (data.invoiceNumber === 0 || data.invoiceNumber === '0') {
                    resultsDiv.innerHTML += '<pre class="error">‚ùå Backend tr·∫£ v·ªÅ invoiceNumber = 0</pre>';
                } else if (data.invoiceNumber) {
                    resultsDiv.innerHTML += `<pre class="success">‚úÖ Backend tr·∫£ v·ªÅ invoiceNumber = ${data.invoiceNumber}</pre>`;
                } else {
                    resultsDiv.innerHTML += '<pre class="warning">‚ö†Ô∏è Backend response kh√¥ng c√≥ field invoiceNumber</pre>';
                }
                
                // Test 2: Verify with getById
                resultsDiv.innerHTML += '<h3>Test 2: Get Invoice By ID</h3>';
                resultsDiv.innerHTML += '<p>‚è≥ Fetching invoice data...</p>';
                
                const getResponse = await fetch(`http://159.223.64.31/api/Invoice/${invoiceId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': token,
                        'Accept': '*/*'
                    }
                });
                
                const getDataText = await getResponse.text();
                const getData = JSON.parse(getDataText);
                
                console.log('GET /api/Invoice response:', getData);
                
                resultsDiv.innerHTML += `<pre><strong>Invoice Data:</strong>\n${JSON.stringify(getData, null, 2)}</pre>`;
                resultsDiv.innerHTML += `<pre>Invoice Number trong DB: ${getData.invoiceNumber}</pre>`;
                resultsDiv.innerHTML += `<pre>Invoice Status: ${getData.invoiceStatusID}</pre>`;
                
                // Final analysis
                resultsDiv.innerHTML += '<h3>üìä Analysis:</h3>';
                resultsDiv.innerHTML += `<pre>
POST /sign response invoiceNumber: ${data.invoiceNumber}
GET /Invoice database invoiceNumber: ${getData.invoiceNumber}
Status: ${getData.invoiceStatusID}
Has signature: ${getData.digitalSignature ? 'Yes' : 'No'}

K·∫øt lu·∫≠n:
${data.invoiceNumber !== null && data.invoiceNumber !== 0 ? 
    '‚úÖ Backend /sign API C√ì c·∫•p s·ªë!' : 
    '‚ùå Backend /sign API KH√îNG c·∫•p s·ªë (tr·∫£ v·ªÅ null/0)'}
${getData.invoiceNumber !== 0 && getData.invoiceNumber !== '0' ? 
    '‚úÖ Database c√≥ s·ªë h√≥a ƒë∆°n' : 
    '‚ùå Database KH√îNG c√≥ s·ªë h√≥a ƒë∆°n'}
</pre>`;
                
            } catch (error) {
                console.error('Error:', error);
                resultsDiv.innerHTML += `<pre class="error">‚ùå Error: ${error.message}\n\n${error.stack}</pre>`;
            }
        }
        
        function testSwagger() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <h3>üìñ Swagger Test Instructions:</h3>
                <pre>
1. M·ªü: http://159.223.64.31/swagger
2. T√¨m endpoint: POST /api/Invoice/{id}/sign
3. Click "Try it out"
4. Nh·∫≠p invoice ID (v√≠ d·ª•: 60)
5. Click "Execute"
6. Xem Response body:
   - N·∫øu c√≥ {"invoiceNumber": 15} ‚Üí Backend OK ‚úÖ
   - N·∫øu c√≥ {"invoiceNumber": null} ‚Üí Backend ch∆∞a c·∫•p s·ªë ‚ùå
   
7. So s√°nh v·ªõi k·∫øt qu·∫£ frontend test ·ªü tr√™n
</pre>
            `;
        }
    </script>
</body>
</html>
