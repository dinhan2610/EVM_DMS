# ğŸ“Š PhÃ¢n TÃ­ch ChuyÃªn Nghiá»‡p: HÃ³a ÄÆ¡n Äiá»u Chá»‰nh & Thay Tháº¿

## ğŸ¯ Executive Summary

ÄÃ¢y lÃ  phÃ¢n tÃ­ch chi tiáº¿t vá» **nghiá»‡p vá»¥ hÃ³a Ä‘Æ¡n Ä‘iá»u chá»‰nh (Adjustment) vÃ  hÃ³a Ä‘Æ¡n thay tháº¿ (Replacement)** theo **Nghá»‹ Ä‘á»‹nh 123/2020/NÄ-CP** vÃ  **ThÃ´ng tÆ° 78/2021/TT-BTC** cá»§a Bá»™ TÃ i chÃ­nh Viá»‡t Nam.

---

## ğŸ“‹ 1. PHÃ‚N TÃCH NGHIá»†P Vá»¤ THEO PHÃP LUáº¬T

### 1.1. HÃ³a ÄÆ¡n Äiá»u Chá»‰nh (Invoice Adjustment)

**Äá»‹nh nghÄ©a (Theo ThÃ´ng tÆ° 78/2021):**
> HÃ³a Ä‘Æ¡n Ä‘iá»u chá»‰nh Ä‘Æ°á»£c láº­p khi phÃ¡t hiá»‡n sai sÃ³t **chá»‰ vá» giÃ¡ trá»‹** (sá»‘ lÆ°á»£ng, Ä‘Æ¡n giÃ¡, thuáº¿ suáº¥t) sau khi hÃ³a Ä‘Æ¡n Ä‘Ã£ Ä‘Æ°á»£c phÃ¡t hÃ nh.

**Äiá»u kiá»‡n Ã¡p dá»¥ng:**
- âœ… HÃ³a Ä‘Æ¡n gá»‘c Ä‘Ã£ Ä‘Æ°á»£c phÃ¡t hÃ nh (ISSUED)
- âœ… ThÃ´ng tin ngÆ°á»i mua, ngÆ°á»i bÃ¡n KHÃ”NG SAI
- âœ… Chá»‰ Ä‘iá»u chá»‰nh: Sá»‘ lÆ°á»£ng, ÄÆ¡n giÃ¡, Thuáº¿ suáº¥t, Tiá»n thuáº¿
- âœ… KhÃ´ng Ä‘Æ°á»£c thay Ä‘á»•i tÃªn hÃ ng hÃ³a/dá»‹ch vá»¥
- âš ï¸ **KHÃ”NG** thay Ä‘á»•i thÃ´ng tin khÃ¡ch hÃ ng

**Káº¿t quáº£:**
- HÃ³a Ä‘Æ¡n Ä‘iá»u chá»‰nh Ä‘Æ°á»£c láº­p má»›i (cÃ³ sá»‘ hÃ³a Ä‘Æ¡n riÃªng)
- HÃ³a Ä‘Æ¡n gá»‘c **VáºªN CÃ“ HIá»†U Lá»°C**, khÃ´ng bá»‹ há»§y
- GiÃ¡ trá»‹ cuá»‘i cÃ¹ng = HÃ³a Ä‘Æ¡n gá»‘c + HÃ³a Ä‘Æ¡n Ä‘iá»u chá»‰nh

**VÃ­ dá»¥ thá»±c táº¿:**
```
HÃ³a Ä‘Æ¡n gá»‘c: INV-001 - 10,000,000 VNÄ (10% VAT) = 11,000,000 VNÄ
PhÃ¡t hiá»‡n: Thiáº¿u 2 sáº£n pháº©m, giÃ¡ trá»‹ +2,000,000 VNÄ

â†’ Táº¡o HÃ³a Ä‘Æ¡n Ä‘iá»u chá»‰nh: INV-001-ADJ-001
  GiÃ¡ trá»‹ Ä‘iá»u chá»‰nh: +2,000,000 VNÄ
  Thuáº¿ VAT 10%: +200,000 VNÄ
  Tá»•ng Ä‘iá»u chá»‰nh: +2,200,000 VNÄ

â†’ GiÃ¡ trá»‹ thá»±c táº¿ = 11,000,000 + 2,200,000 = 13,200,000 VNÄ
```

---

### 1.2. HÃ³a ÄÆ¡n Thay Tháº¿ (Invoice Replacement)

**Äá»‹nh nghÄ©a (Theo ThÃ´ng tÆ° 78/2021):**
> HÃ³a Ä‘Æ¡n thay tháº¿ Ä‘Æ°á»£c láº­p khi phÃ¡t hiá»‡n sai sÃ³t **vá» thÃ´ng tin ngÆ°á»i mua, ngÆ°á»i bÃ¡n, hoáº·c ná»™i dung hÃ ng hÃ³a/dá»‹ch vá»¥** sau khi hÃ³a Ä‘Æ¡n Ä‘Ã£ Ä‘Æ°á»£c phÃ¡t hÃ nh.

**Äiá»u kiá»‡n Ã¡p dá»¥ng:**
- âœ… HÃ³a Ä‘Æ¡n gá»‘c Ä‘Ã£ Ä‘Æ°á»£c phÃ¡t hÃ nh (ISSUED)
- âœ… Sai sÃ³t vá»: TÃªn khÃ¡ch hÃ ng, MÃ£ sá»‘ thuáº¿, Äá»‹a chá»‰
- âœ… Sai sÃ³t vá»: TÃªn hÃ ng hÃ³a/dá»‹ch vá»¥
- âœ… Sai sÃ³t vá»: ÄÆ¡n vá»‹ tÃ­nh
- âœ… CÃ³ thá»ƒ thay Ä‘á»•i toÃ n bá»™ ná»™i dung

**Káº¿t quáº£:**
- HÃ³a Ä‘Æ¡n thay tháº¿ Ä‘Æ°á»£c láº­p má»›i (cÃ³ sá»‘ hÃ³a Ä‘Æ¡n má»›i)
- HÃ³a Ä‘Æ¡n gá»‘c **Bá»Š Há»¦Y Bá»** (khÃ´ng cÃ²n hiá»‡u lá»±c)
- HÃ³a Ä‘Æ¡n thay tháº¿ cÃ³ ghi chÃº "Thay tháº¿ cho hÃ³a Ä‘Æ¡n sá»‘ XXX"

**VÃ­ dá»¥ thá»±c táº¿:**
```
HÃ³a Ä‘Æ¡n gá»‘c: INV-001
KhÃ¡ch hÃ ng: CÃ´ng ty ABC (MST: 0123456789)
GiÃ¡ trá»‹: 11,000,000 VNÄ

PhÃ¡t hiá»‡n: Nháº§m tÃªn khÃ¡ch hÃ ng, Ä‘Ãºng pháº£i lÃ  CÃ´ng ty XYZ (MST: 9876543210)

â†’ Táº¡o HÃ³a Ä‘Æ¡n thay tháº¿: INV-002
  KhÃ¡ch hÃ ng Má»šI: CÃ´ng ty XYZ (MST: 9876543210)
  GiÃ¡ trá»‹: 11,000,000 VNÄ (giá»¯ nguyÃªn hoáº·c Ä‘iá»u chá»‰nh)
  Ghi chÃº: "Thay tháº¿ cho hÃ³a Ä‘Æ¡n sá»‘ INV-001 ngÃ y 01/12/2024"

â†’ HÃ³a Ä‘Æ¡n INV-001 âŒ Bá»Š Há»¦Y
â†’ HÃ³a Ä‘Æ¡n INV-002 âœ… CÃ“ HIá»†U Lá»°C
```

---

## ğŸ” 2. PHÃ‚N TÃCH API STRUCTURE

### 2.1. API Adjustment - âš ï¸ CÃ“ Váº¤N Äá»€

```json
{
  "originalInvoiceId": 0,           // âœ… OK
  "performedBy": 0,                 // âœ… OK - User ID thá»±c hiá»‡n
  "adjustmentReason": "string",     // âœ… OK - LÃ½ do Ä‘iá»u chá»‰nh
  "newCustomerId": 0,               // âŒ SAI - KHÃ”NG ÄÆ¯á»¢C THAY Äá»”I KHÃCH HÃ€NG!
  "adjustmentItems": [              // âœ… OK
    {
      "productID": 0,               // âœ… OK
      "quantity": 0,                // âœ… OK
      "unitPrice": 0,               // âœ… OK
      "overrideVATRate": 0          // âœ… OK
    }
  ]
}
```

**ğŸš¨ Váº¤N Äá»€ NGHIÃŠM TRá»ŒNG:**

1. **`newCustomerId` khÃ´ng há»£p lá»‡ trong Adjustment API**
   - Theo quy Ä‘á»‹nh, hÃ³a Ä‘Æ¡n Ä‘iá»u chá»‰nh **KHÃ”NG ÄÆ¯á»¢C** thay Ä‘á»•i thÃ´ng tin khÃ¡ch hÃ ng
   - Náº¿u cáº§n Ä‘á»•i khÃ¡ch hÃ ng â†’ Pháº£i dÃ¹ng **Replacement API**
   - **Khuyáº¿n nghá»‹:** Loáº¡i bá» field `newCustomerId` khá»i Adjustment API

2. **Thiáº¿u field quan trá»ng:**
   - âŒ `adjustmentType`: "INCREASE" | "DECREASE" - Äiá»u chá»‰nh tÄƒng hay giáº£m
   - âŒ `originalInvoiceNumber`: Sá»‘ hÃ³a Ä‘Æ¡n gá»‘c (Ä‘á»ƒ hiá»ƒn thá»‹)
   - âŒ `adjustmentDate`: NgÃ y láº­p hÃ³a Ä‘Æ¡n Ä‘iá»u chá»‰nh

---

### 2.2. API Replacement - âœ… Há»¢P Lá»†

```json
{
  "originalInvoiceId": 0,          // âœ… OK
  "performedBy": 0,                // âœ… OK
  "reason": "string",              // âœ… OK - LÃ½ do thay tháº¿
  "customerId": 0,                 // âœ… OK - Cho phÃ©p Ä‘á»•i khÃ¡ch hÃ ng
  "note": "string",                // âœ… OK - Ghi chÃº
  "items": [                       // âœ… OK
    {
      "productID": 0,
      "quantity": 0,
      "unitPrice": 0,
      "overrideVATRate": 0
    }
  ]
}
```

**âœ… API nÃ y há»£p lá»‡ nhÆ°ng cáº§n cáº£i thiá»‡n:**

1. **Thiáº¿u thÃ´ng tin khÃ¡ch hÃ ng chi tiáº¿t:**
   - âŒ `customerName`: TÃªn khÃ¡ch hÃ ng má»›i
   - âŒ `customerTaxCode`: MST má»›i
   - âŒ `customerAddress`: Äá»‹a chá»‰ má»›i
   - âŒ `customerEmail`: Email má»›i
   - âŒ `customerPhone`: SÄT má»›i

2. **Thiáº¿u validation:**
   - âŒ Kiá»ƒm tra hÃ³a Ä‘Æ¡n gá»‘c cÃ³ á»Ÿ tráº¡ng thÃ¡i ISSUED khÃ´ng
   - âŒ Kiá»ƒm tra hÃ³a Ä‘Æ¡n gá»‘c chÆ°a bá»‹ thay tháº¿ trÆ°á»›c Ä‘Ã³

---

## ğŸ¨ 3. PHÃ‚N TÃCH UI/UX

### 3.1. HÃ³a ÄÆ¡n Äiá»u Chá»‰nh UI - âœ… Tá»T nhÆ°ng cÃ³ thá»ƒ cáº£i thiá»‡n

**âœ… Äiá»ƒm máº¡nh:**
1. âœ… Hiá»ƒn thá»‹ rÃµ thÃ´ng tin hÃ³a Ä‘Æ¡n gá»‘c (sá»‘ HÄ, giÃ¡ trá»‹, ngÃ y phÃ¡t hÃ nh)
2. âœ… ThÃ´ng tin khÃ¡ch hÃ ng DISABLED (khÃ´ng cho sá»­a) - **ÄÃºng nghiá»‡p vá»¥**
3. âœ… CÃ³ field nháº­p lÃ½ do Ä‘iá»u chá»‰nh
4. âœ… TÃ­nh toÃ¡n tá»± Ä‘á»™ng: Subtotal, Tax, Total
5. âœ… Cho phÃ©p thÃªm/xÃ³a dÃ²ng sáº£n pháº©m

**âš ï¸ Thiáº¿u cÃ¡c tÃ­nh nÄƒng quan trá»ng:**

1. **KhÃ´ng cÃ³ cháº¿ Ä‘á»™ "Äiá»u chá»‰nh tÄƒng/giáº£m":**
   ```tsx
   // NÃªn cÃ³ dropdown chá»n:
   <Select value={adjustmentType}>
     <MenuItem value="INCREASE">Äiá»u chá»‰nh TÄ‚NG (+)</MenuItem>
     <MenuItem value="DECREASE">Äiá»u chá»‰nh GIáº¢M (-)</MenuItem>
   </Select>
   ```

2. **KhÃ´ng hiá»ƒn thá»‹ so sÃ¡nh Before/After:**
   ```tsx
   // NÃªn cÃ³ báº£ng so sÃ¡nh:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                 â”‚ HÃ³a Ä‘Æ¡n gá»‘c  â”‚ Äiá»u chá»‰nh    â”‚ Tá»•ng cuá»‘i   â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚ Tá»•ng tiá»n       â”‚ 10,000,000   â”‚ +2,000,000    â”‚ 12,000,000  â”‚
   â”‚ VAT 10%         â”‚  1,000,000   â”‚   +200,000    â”‚  1,200,000  â”‚
   â”‚ Tá»”NG Cá»˜NG       â”‚ 11,000,000   â”‚ +2,200,000    â”‚ 13,200,000  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   ```

3. **KhÃ´ng cÃ³ xÃ¡c nháº­n trÆ°á»›c khi phÃ¡t hÃ nh:**
   - NÃªn cÃ³ modal xÃ¡c nháº­n vá»›i thÃ´ng tin tÃ³m táº¯t
   - Hiá»ƒn thá»‹: "Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n phÃ¡t hÃ nh hÃ³a Ä‘Æ¡n Ä‘iá»u chá»‰nh nÃ y?"
   - Cáº£nh bÃ¡o: "HÃ³a Ä‘Æ¡n Ä‘iá»u chá»‰nh sau khi phÃ¡t hÃ nh khÃ´ng thá»ƒ há»§y"

4. **KhÃ´ng cÃ³ táº£i lÃªn file Ä‘Ã­nh kÃ¨m:**
   - Theo quy Ä‘á»‹nh, cáº§n cÃ³ vÄƒn báº£n giáº£i trÃ¬nh lÃ½ do Ä‘iá»u chá»‰nh
   - NÃªn cÃ³ chá»©c nÄƒng upload file PDF/DOC

---

### 3.2. HÃ³a ÄÆ¡n Thay Tháº¿ UI - âœ… Tá»T nhÆ°ng cáº§n cáº£i thiá»‡n

**âœ… Äiá»ƒm máº¡nh:**
1. âœ… Hiá»ƒn thá»‹ cáº£nh bÃ¡o rÃµ rÃ ng (Warning Alert)
2. âœ… Cho phÃ©p thay Ä‘á»•i toÃ n bá»™ thÃ´ng tin (khÃ¡ch hÃ ng, items)
3. âœ… CÃ³ DatePicker cho ngÃ y phÃ¡t hÃ nh má»›i
4. âœ… CÃ³ field nháº­p lÃ½ do thay tháº¿

**âš ï¸ Thiáº¿u cÃ¡c tÃ­nh nÄƒng quan trá»ng:**

1. **KhÃ´ng cÃ³ nÃºt "Copy tá»« hÃ³a Ä‘Æ¡n gá»‘c":**
   ```tsx
   // NÃªn cÃ³ nÃºt Ä‘á»ƒ copy dá»¯ liá»‡u cÅ©:
   <Button onClick={handleCopyFromOriginal}>
     ğŸ“‹ Sao chÃ©p tá»« hÃ³a Ä‘Æ¡n gá»‘c
   </Button>
   ```

2. **KhÃ´ng hiá»ƒn thá»‹ hÃ³a Ä‘Æ¡n gá»‘c Ä‘á»ƒ so sÃ¡nh:**
   - NÃªn cÃ³ 2 cá»™t: CÅ© vs Má»›i
   - Highlight pháº§n khÃ¡c biá»‡t báº±ng mÃ u

3. **KhÃ´ng cÃ³ xÃ¡c nháº­n nghiÃªm ngáº·t:**
   ```tsx
   // NÃªn cÃ³ checkbox confirm:
   <Checkbox checked={confirmUnderstand}>
     TÃ´i hiá»ƒu ráº±ng hÃ³a Ä‘Æ¡n gá»‘c INV-001 sáº½ Bá»Š Há»¦Y Bá» vÃ  khÃ´ng cÃ²n hiá»‡u lá»±c
   </Checkbox>
   <Checkbox checked={confirmAccuracy}>
     TÃ´i Ä‘Ã£ kiá»ƒm tra ká»¹ thÃ´ng tin trÃªn hÃ³a Ä‘Æ¡n thay tháº¿
   </Checkbox>
   ```

4. **KhÃ´ng cÃ³ preview PDF:**
   - NÃªn cÃ³ nÃºt "Xem trÆ°á»›c" Ä‘á»ƒ xem hÃ³a Ä‘Æ¡n PDF trÆ°á»›c khi phÃ¡t hÃ nh

---

## ğŸ”§ 4. KHUYáº¾N NGHá»Š Cáº¢I TIáº¾N

### 4.1. Backend API Improvements

#### **Adjustment API - Cáº§n sá»­a ngay:**

```typescript
// âŒ CURRENT (SAI):
interface AdjustmentRequest {
  originalInvoiceId: number
  performedBy: number
  adjustmentReason: string
  newCustomerId: number           // âŒ LOáº I Bá» FIELD NÃ€Y
  adjustmentItems: AdjustmentItem[]
}

// âœ… RECOMMENDED (ÄÃšNG):
interface AdjustmentRequest {
  originalInvoiceId: number
  performedBy: number
  adjustmentType: 'INCREASE' | 'DECREASE'  // âœ… THÃŠM
  adjustmentReason: string
  adjustmentDate?: string          // âœ… THÃŠM (optional, default = today)
  adjustmentItems: AdjustmentItem[]
  attachments?: File[]             // âœ… THÃŠM - VÄƒn báº£n giáº£i trÃ¬nh
}

interface AdjustmentItem {
  productID: number
  description?: string             // âœ… THÃŠM - MÃ´ táº£ Ä‘iá»u chá»‰nh
  quantity: number                 // CÃ³ thá»ƒ Ã¢m náº¿u giáº£m
  unitPrice: number
  overrideVATRate?: number
}
```

#### **Replacement API - Cáº§n bá»• sung:**

```typescript
// âŒ CURRENT (THIáº¾U):
interface ReplacementRequest {
  originalInvoiceId: number
  performedBy: number
  reason: string
  customerId: number               // âŒ KHÃ”NG Äá»¦
  note: string
  items: ReplacementItem[]
}

// âœ… RECOMMENDED (Äáº¦Y Äá»¦):
interface ReplacementRequest {
  originalInvoiceId: number
  performedBy: number
  reason: string
  replacementDate?: string         // âœ… THÃŠM
  
  // âœ… ThÃ´ng tin khÃ¡ch hÃ ng Äáº¦Y Äá»¦:
  customer: {
    id?: number                    // Optional náº¿u lÃ  khÃ¡ch hÃ ng má»›i
    name: string
    taxCode: string
    address: string
    email: string
    phone: string
  }
  
  note: string
  items: ReplacementItem[]
  attachments?: File[]             // âœ… THÃŠM
}
```

---

### 4.2. Frontend UI/UX Improvements

#### **HÃ³a ÄÆ¡n Äiá»u Chá»‰nh:**

1. **ThÃªm Adjustment Type Selector:**
```tsx
<FormControl fullWidth>
  <InputLabel>Loáº¡i Ä‘iá»u chá»‰nh</InputLabel>
  <Select value={adjustmentType} onChange={handleTypeChange}>
    <MenuItem value="INCREASE">
      <Stack direction="row" spacing={1} alignItems="center">
        <TrendingUpIcon color="success" />
        <Typography>Äiá»u chá»‰nh TÄ‚NG giÃ¡ trá»‹</Typography>
      </Stack>
    </MenuItem>
    <MenuItem value="DECREASE">
      <Stack direction="row" spacing={1} alignItems="center">
        <TrendingDownIcon color="error" />
        <Typography>Äiá»u chá»‰nh GIáº¢M giÃ¡ trá»‹</Typography>
      </Stack>
    </MenuItem>
  </Select>
</FormControl>
```

2. **ThÃªm Comparison Table:**
```tsx
<TableContainer component={Paper}>
  <Table>
    <TableHead>
      <TableRow>
        <TableCell>Chá»‰ tiÃªu</TableCell>
        <TableCell align="right">HÃ³a Ä‘Æ¡n gá»‘c</TableCell>
        <TableCell align="right">Äiá»u chá»‰nh</TableCell>
        <TableCell align="right">Tá»•ng cuá»‘i</TableCell>
      </TableRow>
    </TableHead>
    <TableBody>
      <TableRow>
        <TableCell>Tá»•ng tiá»n hÃ ng</TableCell>
        <TableCell align="right">{formatCurrency(originalSubtotal)}</TableCell>
        <TableCell align="right" sx={{ color: adjustmentType === 'INCREASE' ? 'green' : 'red' }}>
          {adjustmentType === 'INCREASE' ? '+' : '-'}{formatCurrency(adjustmentSubtotal)}
        </TableCell>
        <TableCell align="right" sx={{ fontWeight: 'bold' }}>
          {formatCurrency(finalSubtotal)}
        </TableCell>
      </TableRow>
      {/* TÆ°Æ¡ng tá»± cho VAT vÃ  Total */}
    </TableBody>
  </Table>
</TableContainer>
```

3. **ThÃªm File Upload:**
```tsx
<Box sx={{ mt: 3 }}>
  <Typography variant="subtitle1" sx={{ mb: 1 }}>
    VÄƒn báº£n giáº£i trÃ¬nh (báº¯t buá»™c)
  </Typography>
  <Button
    variant="outlined"
    component="label"
    startIcon={<AttachFileIcon />}
  >
    Táº£i lÃªn file Ä‘Ã­nh kÃ¨m
    <input type="file" hidden accept=".pdf,.doc,.docx" onChange={handleFileUpload} />
  </Button>
  {attachments.length > 0 && (
    <List>
      {attachments.map((file, index) => (
        <ListItem key={index}>
          <ListItemIcon><DescriptionIcon /></ListItemIcon>
          <ListItemText primary={file.name} secondary={formatFileSize(file.size)} />
          <IconButton onClick={() => handleRemoveFile(index)}>
            <DeleteIcon />
          </IconButton>
        </ListItem>
      ))}
    </List>
  )}
</Box>
```

4. **ThÃªm Confirmation Modal:**
```tsx
<Dialog open={showConfirmModal} maxWidth="md" fullWidth>
  <DialogTitle>
    <Stack direction="row" spacing={1} alignItems="center">
      <WarningIcon color="warning" />
      <Typography variant="h6">XÃ¡c nháº­n phÃ¡t hÃ nh hÃ³a Ä‘Æ¡n Ä‘iá»u chá»‰nh</Typography>
    </Stack>
  </DialogTitle>
  <DialogContent>
    <Alert severity="warning" sx={{ mb: 2 }}>
      HÃ³a Ä‘Æ¡n Ä‘iá»u chá»‰nh sau khi phÃ¡t hÃ nh khÃ´ng thá»ƒ há»§y hoáº·c chá»‰nh sá»­a
    </Alert>
    
    <Typography variant="subtitle1" sx={{ mb: 2 }}>ThÃ´ng tin tÃ³m táº¯t:</Typography>
    
    <Stack spacing={1}>
      <Box sx={{ display: 'flex', justifyContent: 'space-between' }}>
        <Typography color="text.secondary">HÃ³a Ä‘Æ¡n gá»‘c:</Typography>
        <Typography fontWeight="bold">{originalInvoiceNumber}</Typography>
      </Box>
      <Box sx={{ display: 'flex', justifyContent: 'space-between' }}>
        <Typography color="text.secondary">Loáº¡i Ä‘iá»u chá»‰nh:</Typography>
        <Typography fontWeight="bold" color={adjustmentType === 'INCREASE' ? 'success.main' : 'error.main'}>
          {adjustmentType === 'INCREASE' ? 'TÄ‚NG' : 'GIáº¢M'} giÃ¡ trá»‹
        </Typography>
      </Box>
      <Box sx={{ display: 'flex', justifyContent: 'space-between' }}>
        <Typography color="text.secondary">GiÃ¡ trá»‹ Ä‘iá»u chá»‰nh:</Typography>
        <Typography fontWeight="bold" fontSize="1.2rem">
          {adjustmentType === 'INCREASE' ? '+' : '-'}{formatCurrency(totalAdjustment)}
        </Typography>
      </Box>
      <Divider />
      <Box sx={{ display: 'flex', justifyContent: 'space-between' }}>
        <Typography color="text.secondary">GiÃ¡ trá»‹ cuá»‘i cÃ¹ng:</Typography>
        <Typography fontWeight="bold" fontSize="1.3rem" color="primary">
          {formatCurrency(finalTotal)}
        </Typography>
      </Box>
    </Stack>
  </DialogContent>
  <DialogActions>
    <Button onClick={handleCloseModal}>Há»§y</Button>
    <Button variant="contained" onClick={handleConfirmIssue}>
      XÃ¡c nháº­n phÃ¡t hÃ nh
    </Button>
  </DialogActions>
</Dialog>
```

---

#### **HÃ³a ÄÆ¡n Thay Tháº¿:**

1. **ThÃªm Copy Button:**
```tsx
<Box sx={{ mb: 2 }}>
  <Button
    variant="outlined"
    startIcon={<ContentCopyIcon />}
    onClick={handleCopyFromOriginal}
  >
    ğŸ“‹ Sao chÃ©p thÃ´ng tin tá»« hÃ³a Ä‘Æ¡n gá»‘c
  </Button>
</Box>
```

2. **ThÃªm Side-by-Side Comparison:**
```tsx
<Grid container spacing={2}>
  {/* Cá»™t BÃŠN TRÃI: HÃ³a Ä‘Æ¡n gá»‘c (Read-only) */}
  <Grid item xs={12} md={6}>
    <Paper sx={{ p: 2, backgroundColor: '#f5f5f5' }}>
      <Typography variant="h6" sx={{ mb: 2, color: 'error.main' }}>
        âŒ HÃ³a Ä‘Æ¡n gá»‘c (sáº½ bá»‹ há»§y)
      </Typography>
      <TextField
        fullWidth
        label="TÃªn khÃ¡ch hÃ ng"
        value={originalInvoice.customerName}
        disabled
        sx={{ mb: 2 }}
      />
      <TextField
        fullWidth
        label="MÃ£ sá»‘ thuáº¿"
        value={originalInvoice.customerTaxCode}
        disabled
        sx={{ mb: 2 }}
      />
      {/* ... cÃ¡c field khÃ¡c */}
    </Paper>
  </Grid>
  
  {/* Cá»™t BÃŠN PHáº¢I: HÃ³a Ä‘Æ¡n thay tháº¿ (Editable) */}
  <Grid item xs={12} md={6}>
    <Paper sx={{ p: 2, backgroundColor: '#e8f5e9' }}>
      <Typography variant="h6" sx={{ mb: 2, color: 'success.main' }}>
        âœ… HÃ³a Ä‘Æ¡n thay tháº¿ (má»›i)
      </Typography>
      <TextField
        fullWidth
        label="TÃªn khÃ¡ch hÃ ng"
        value={formData.customerName}
        onChange={(e) => handleChange('customerName', e.target.value)}
        sx={{ mb: 2 }}
      />
      <TextField
        fullWidth
        label="MÃ£ sá»‘ thuáº¿"
        value={formData.customerTaxCode}
        onChange={(e) => handleChange('customerTaxCode', e.target.value)}
        sx={{ mb: 2 }}
      />
      {/* ... cÃ¡c field khÃ¡c */}
    </Paper>
  </Grid>
</Grid>
```

3. **ThÃªm Strict Confirmation:**
```tsx
<Box sx={{ mt: 3, p: 2, border: '2px solid #ff9800', borderRadius: 1, backgroundColor: '#fff3e0' }}>
  <Typography variant="subtitle1" sx={{ mb: 2, fontWeight: 'bold', color: '#f57c00' }}>
    âš ï¸ XÃ¡c nháº­n thÃ´ng tin (Báº¯t buá»™c)
  </Typography>
  
  <FormControlLabel
    control={
      <Checkbox
        checked={confirmations.understandCancel}
        onChange={(e) => handleConfirmationChange('understandCancel', e.target.checked)}
      />
    }
    label={
      <Typography>
        TÃ´i hiá»ƒu ráº±ng hÃ³a Ä‘Æ¡n gá»‘c <strong>{originalInvoiceNumber}</strong> sáº½ Bá»Š Há»¦Y Bá» hoÃ n toÃ n vÃ  khÃ´ng cÃ²n hiá»‡u lá»±c phÃ¡p lÃ½
      </Typography>
    }
  />
  
  <FormControlLabel
    control={
      <Checkbox
        checked={confirmations.verifiedAccuracy}
        onChange={(e) => handleConfirmationChange('verifiedAccuracy', e.target.checked)}
      />
    }
    label={
      <Typography>
        TÃ´i Ä‘Ã£ kiá»ƒm tra ká»¹ lÆ°á»¡ng táº¥t cáº£ thÃ´ng tin trÃªn hÃ³a Ä‘Æ¡n thay tháº¿ vÃ  xÃ¡c nháº­n thÃ´ng tin chÃ­nh xÃ¡c 100%
      </Typography>
    }
  />
  
  <FormControlLabel
    control={
      <Checkbox
        checked={confirmations.notifiedCustomer}
        onChange={(e) => handleConfirmationChange('notifiedCustomer', e.target.checked)}
      />
    }
    label={
      <Typography>
        TÃ´i sáº½ thÃ´ng bÃ¡o cho khÃ¡ch hÃ ng vá» viá»‡c thay tháº¿ hÃ³a Ä‘Æ¡n vÃ  gá»­i hÃ³a Ä‘Æ¡n má»›i
      </Typography>
    }
  />
</Box>

<Button
  variant="contained"
  fullWidth
  disabled={!Object.values(confirmations).every(v => v)}
  onClick={handleIssueReplacement}
  sx={{ mt: 2 }}
>
  PhÃ¡t hÃ nh hÃ³a Ä‘Æ¡n thay tháº¿
</Button>
```

---

### 4.3. Business Logic Improvements

#### **Validation Rules:**

1. **Adjustment Invoice:**
```typescript
const validateAdjustment = (data: AdjustmentData): ValidationResult => {
  const errors: string[] = []
  
  // 1. Check hÃ³a Ä‘Æ¡n gá»‘c pháº£i á»Ÿ tráº¡ng thÃ¡i ISSUED
  if (originalInvoice.status !== 'ISSUED') {
    errors.push('Chá»‰ cÃ³ thá»ƒ Ä‘iá»u chá»‰nh hÃ³a Ä‘Æ¡n Ä‘Ã£ phÃ¡t hÃ nh')
  }
  
  // 2. Check hÃ³a Ä‘Æ¡n gá»‘c khÃ´ng Ä‘Æ°á»£c bá»‹ há»§y hoáº·c thay tháº¿
  if (originalInvoice.isCancelled || originalInvoice.isReplaced) {
    errors.push('HÃ³a Ä‘Æ¡n gá»‘c Ä‘Ã£ bá»‹ há»§y hoáº·c thay tháº¿, khÃ´ng thá»ƒ Ä‘iá»u chá»‰nh')
  }
  
  // 3. Check pháº£i cÃ³ Ã­t nháº¥t 1 item Ä‘iá»u chá»‰nh
  if (data.adjustmentItems.length === 0) {
    errors.push('Pháº£i cÃ³ Ã­t nháº¥t 1 sáº£n pháº©m/dá»‹ch vá»¥ Ä‘iá»u chá»‰nh')
  }
  
  // 4. Check giÃ¡ trá»‹ Ä‘iá»u chá»‰nh khÃ´ng Ä‘Æ°á»£c báº±ng 0
  const totalAdjustment = calculateTotalAdjustment(data.adjustmentItems)
  if (totalAdjustment === 0) {
    errors.push('GiÃ¡ trá»‹ Ä‘iá»u chá»‰nh pháº£i khÃ¡c 0')
  }
  
  // 5. Check pháº£i cÃ³ lÃ½ do Ä‘iá»u chá»‰nh
  if (!data.adjustmentReason || data.adjustmentReason.trim().length < 10) {
    errors.push('LÃ½ do Ä‘iá»u chá»‰nh pháº£i cÃ³ Ã­t nháº¥t 10 kÃ½ tá»±')
  }
  
  // 6. Check pháº£i cÃ³ file Ä‘Ã­nh kÃ¨m (vÄƒn báº£n giáº£i trÃ¬nh)
  if (!data.attachments || data.attachments.length === 0) {
    errors.push('Pháº£i cÃ³ vÄƒn báº£n giáº£i trÃ¬nh lÃ½ do Ä‘iá»u chá»‰nh')
  }
  
  return {
    isValid: errors.length === 0,
    errors
  }
}
```

2. **Replacement Invoice:**
```typescript
const validateReplacement = (data: ReplacementData): ValidationResult => {
  const errors: string[] = []
  
  // 1. Check hÃ³a Ä‘Æ¡n gá»‘c pháº£i á»Ÿ tráº¡ng thÃ¡i ISSUED
  if (originalInvoice.status !== 'ISSUED') {
    errors.push('Chá»‰ cÃ³ thá»ƒ thay tháº¿ hÃ³a Ä‘Æ¡n Ä‘Ã£ phÃ¡t hÃ nh')
  }
  
  // 2. Check hÃ³a Ä‘Æ¡n gá»‘c chÆ°a bá»‹ thay tháº¿ trÆ°á»›c Ä‘Ã³
  if (originalInvoice.isReplaced) {
    errors.push('HÃ³a Ä‘Æ¡n gá»‘c Ä‘Ã£ Ä‘Æ°á»£c thay tháº¿, khÃ´ng thá»ƒ thay tháº¿ láº¡i')
  }
  
  // 3. Check pháº£i cÃ³ thay Ä‘á»•i so vá»›i hÃ³a Ä‘Æ¡n gá»‘c
  if (isIdenticalToOriginal(data, originalInvoice)) {
    errors.push('HÃ³a Ä‘Æ¡n thay tháº¿ pháº£i cÃ³ Ã­t nháº¥t 1 thay Ä‘á»•i so vá»›i hÃ³a Ä‘Æ¡n gá»‘c')
  }
  
  // 4. Check thÃ´ng tin khÃ¡ch hÃ ng Ä‘áº§y Ä‘á»§
  if (!data.customer.name || !data.customer.taxCode || !data.customer.address) {
    errors.push('ThÃ´ng tin khÃ¡ch hÃ ng khÃ´ng Ä‘áº§y Ä‘á»§')
  }
  
  // 5. Check mÃ£ sá»‘ thuáº¿ há»£p lá»‡
  if (!isValidTaxCode(data.customer.taxCode)) {
    errors.push('MÃ£ sá»‘ thuáº¿ khÃ´ng há»£p lá»‡')
  }
  
  // 6. Check pháº£i cÃ³ lÃ½ do thay tháº¿
  if (!data.reason || data.reason.trim().length < 20) {
    errors.push('LÃ½ do thay tháº¿ pháº£i cÃ³ Ã­t nháº¥t 20 kÃ½ tá»± vÃ  giáº£i thÃ­ch rÃµ rÃ ng')
  }
  
  // 7. Check user confirmations
  if (!data.confirmations?.understandCancel || 
      !data.confirmations?.verifiedAccuracy ||
      !data.confirmations?.notifiedCustomer) {
    errors.push('Pháº£i xÃ¡c nháº­n Ä‘áº§y Ä‘á»§ cÃ¡c thÃ´ng tin trÆ°á»›c khi phÃ¡t hÃ nh')
  }
  
  return {
    isValid: errors.length === 0,
    errors
  }
}
```

---

### 4.4. Database Schema Improvements

```sql
-- Table: invoice_adjustments
CREATE TABLE invoice_adjustments (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  adjustment_number VARCHAR(50) UNIQUE NOT NULL, -- INV-001-ADJ-001
  original_invoice_id BIGINT NOT NULL,
  adjustment_type ENUM('INCREASE', 'DECREASE') NOT NULL,
  adjustment_reason TEXT NOT NULL,
  adjustment_date DATETIME NOT NULL,
  performed_by BIGINT NOT NULL,
  
  -- Financial info
  original_subtotal DECIMAL(18,2) NOT NULL,
  original_vat_amount DECIMAL(18,2) NOT NULL,
  original_total DECIMAL(18,2) NOT NULL,
  
  adjustment_subtotal DECIMAL(18,2) NOT NULL,
  adjustment_vat_amount DECIMAL(18,2) NOT NULL,
  adjustment_total DECIMAL(18,2) NOT NULL,
  
  final_subtotal DECIMAL(18,2) NOT NULL,
  final_vat_amount DECIMAL(18,2) NOT NULL,
  final_total DECIMAL(18,2) NOT NULL,
  
  -- Metadata
  status ENUM('DRAFT', 'ISSUED') DEFAULT 'DRAFT',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  
  FOREIGN KEY (original_invoice_id) REFERENCES invoices(id),
  FOREIGN KEY (performed_by) REFERENCES users(id),
  INDEX idx_original_invoice (original_invoice_id),
  INDEX idx_adjustment_date (adjustment_date)
);

-- Table: invoice_adjustment_items
CREATE TABLE invoice_adjustment_items (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  adjustment_id BIGINT NOT NULL,
  product_id BIGINT NOT NULL,
  description TEXT,
  quantity INT NOT NULL, -- CÃ³ thá»ƒ Ã¢m náº¿u giáº£m
  unit_price DECIMAL(18,2) NOT NULL,
  vat_rate DECIMAL(5,2) NOT NULL,
  line_total DECIMAL(18,2) NOT NULL,
  
  FOREIGN KEY (adjustment_id) REFERENCES invoice_adjustments(id),
  FOREIGN KEY (product_id) REFERENCES products(id)
);

-- Table: invoice_replacements
CREATE TABLE invoice_replacements (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  replacement_invoice_id BIGINT UNIQUE NOT NULL, -- ID cá»§a hÃ³a Ä‘Æ¡n thay tháº¿ má»›i
  original_invoice_id BIGINT UNIQUE NOT NULL,    -- Má»—i HÄ gá»‘c chá»‰ Ä‘Æ°á»£c thay tháº¿ 1 láº§n
  replacement_reason TEXT NOT NULL,
  replacement_date DATETIME NOT NULL,
  performed_by BIGINT NOT NULL,
  
  -- Customer info changes (cÃ³ thá»ƒ NULL náº¿u khÃ´ng Ä‘á»•i)
  new_customer_id BIGINT,
  new_customer_name VARCHAR(255),
  new_customer_tax_code VARCHAR(20),
  new_customer_address TEXT,
  new_customer_email VARCHAR(255),
  new_customer_phone VARCHAR(20),
  
  -- Metadata
  status ENUM('COMPLETED', 'CANCELLED') DEFAULT 'COMPLETED',
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  
  FOREIGN KEY (replacement_invoice_id) REFERENCES invoices(id),
  FOREIGN KEY (original_invoice_id) REFERENCES invoices(id),
  FOREIGN KEY (performed_by) REFERENCES users(id),
  FOREIGN KEY (new_customer_id) REFERENCES customers(id),
  
  INDEX idx_original_invoice (original_invoice_id),
  INDEX idx_replacement_date (replacement_date)
);

-- Add columns to invoices table
ALTER TABLE invoices ADD COLUMN is_adjustment BOOLEAN DEFAULT FALSE;
ALTER TABLE invoices ADD COLUMN is_replacement BOOLEAN DEFAULT FALSE;
ALTER TABLE invoices ADD COLUMN original_invoice_id BIGINT NULL;
ALTER TABLE invoices ADD COLUMN replaced_by_invoice_id BIGINT NULL;

ALTER TABLE invoices ADD FOREIGN KEY (original_invoice_id) REFERENCES invoices(id);
ALTER TABLE invoices ADD FOREIGN KEY (replaced_by_invoice_id) REFERENCES invoices(id);
```

---

## ğŸ“Š 5. WORKFLOW COMPARISON

### 5.1. Adjustment Workflow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         LUá»’NG Xá»¬ LÃ HÃ“A ÄÆ N ÄIá»€U CHá»ˆNH                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. User chá»n "Táº¡o HÄ Ä‘iá»u chá»‰nh" tá»« hÃ³a Ä‘Æ¡n gá»‘c
   â”‚
   â–¼
2. System kiá»ƒm tra:
   âœ“ HÃ³a Ä‘Æ¡n gá»‘c status = ISSUED?
   âœ“ ChÆ°a bá»‹ há»§y?
   âœ“ ChÆ°a bá»‹ thay tháº¿?
   â”‚
   â”œâ”€ âŒ KhÃ´ng Ä‘áº¡t â†’ Hiá»ƒn thá»‹ lá»—i
   â”‚
   â””â”€ âœ… Äáº¡t â†’ Chuyá»ƒn Ä‘áº¿n trang táº¡o Ä‘iá»u chá»‰nh
       â”‚
       â–¼
3. User nháº­p:
   â€¢ Chá»n loáº¡i: TÄ‚NG / GIáº¢M
   â€¢ Nháº­p lÃ½ do Ä‘iá»u chá»‰nh
   â€¢ ThÃªm/sá»­a items
   â€¢ Upload file giáº£i trÃ¬nh
   â”‚
   â–¼
4. System tÃ­nh toÃ¡n:
   â€¢ GiÃ¡ trá»‹ Ä‘iá»u chá»‰nh = Î£ (quantity Ã— unitPrice)
   â€¢ VAT Ä‘iá»u chá»‰nh = GiÃ¡ trá»‹ Ã— VAT rate
   â€¢ Tá»•ng Ä‘iá»u chá»‰nh = GiÃ¡ trá»‹ + VAT
   â”‚
   â€¢ GiÃ¡ trá»‹ cuá»‘i = Gá»‘c + Äiá»u chá»‰nh
   â”‚
   â–¼
5. User click "PhÃ¡t hÃ nh"
   â”‚
   â–¼
6. System hiá»ƒn thá»‹ Modal xÃ¡c nháº­n:
   â€¢ TÃ³m táº¯t thÃ´ng tin
   â€¢ Cáº£nh bÃ¡o khÃ´ng thá»ƒ há»§y
   â”‚
   â”œâ”€ User click "Há»§y" â†’ Quay láº¡i form
   â”‚
   â””â”€ User click "XÃ¡c nháº­n"
       â”‚
       â–¼
7. System gá»i API:
   POST /api/Invoice/adjustment
   {
     "originalInvoiceId": 123,
     "adjustmentType": "INCREASE",
     "adjustmentReason": "...",
     "adjustmentItems": [...]
   }
   â”‚
   â–¼
8. Backend xá»­ lÃ½:
   â€¢ Táº¡o record má»›i trong invoice_adjustments
   â€¢ Táº¡o invoice_adjustment_items
   â€¢ Cáº­p nháº­t financial summary cá»§a invoice gá»‘c
   â€¢ Ghi audit log
   â”‚
   â–¼
9. Response:
   â€¢ Status: 200 OK
   â€¢ Data: { adjustmentId, adjustmentNumber, ... }
   â”‚
   â–¼
10. Frontend:
    â€¢ Hiá»ƒn thá»‹ thÃ´ng bÃ¡o thÃ nh cÃ´ng
    â€¢ Redirect vá» trang chi tiáº¿t HÄ gá»‘c
    â€¢ Hiá»ƒn thá»‹ lá»‹ch sá»­ Ä‘iá»u chá»‰nh
```

---

### 5.2. Replacement Workflow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          LUá»’NG Xá»¬ LÃ HÃ“A ÄÆ N THAY THáº¾                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. User chá»n "Táº¡o HÄ thay tháº¿" tá»« hÃ³a Ä‘Æ¡n gá»‘c
   â”‚
   â–¼
2. System kiá»ƒm tra:
   âœ“ HÃ³a Ä‘Æ¡n gá»‘c status = ISSUED?
   âœ“ ChÆ°a bá»‹ thay tháº¿ trÆ°á»›c Ä‘Ã³?
   â”‚
   â”œâ”€ âŒ KhÃ´ng Ä‘áº¡t â†’ Hiá»ƒn thá»‹ lá»—i
   â”‚
   â””â”€ âœ… Äáº¡t â†’ Chuyá»ƒn Ä‘áº¿n trang táº¡o thay tháº¿
       â”‚
       â–¼
3. System hiá»ƒn thá»‹:
   â€¢ Cá»™t BÃŠN TRÃI: HÃ³a Ä‘Æ¡n gá»‘c (read-only)
   â€¢ Cá»™t BÃŠN PHáº¢I: HÃ³a Ä‘Æ¡n thay tháº¿ (editable)
   â”‚
   â–¼
4. User cÃ³ thá»ƒ:
   â€¢ Click "Sao chÃ©p tá»« gá»‘c" â†’ Auto-fill form
   â€¢ Sá»­a thÃ´ng tin khÃ¡ch hÃ ng
   â€¢ Sá»­a items
   â€¢ Nháº­p lÃ½ do thay tháº¿
   â”‚
   â–¼
5. System validation real-time:
   âœ“ CÃ³ thay Ä‘á»•i so vá»›i gá»‘c?
   âœ“ MST há»£p lá»‡?
   âœ“ LÃ½ do >= 20 kÃ½ tá»±?
   â”‚
   â–¼
6. User check 3 confirmations:
   â˜‘ Hiá»ƒu hÃ³a Ä‘Æ¡n gá»‘c bá»‹ há»§y
   â˜‘ ÄÃ£ kiá»ƒm tra ká»¹
   â˜‘ Sáº½ thÃ´ng bÃ¡o khÃ¡ch hÃ ng
   â”‚
   â–¼
7. User click "PhÃ¡t hÃ nh" (disabled náº¿u chÆ°a check Ä‘á»§)
   â”‚
   â–¼
8. System hiá»ƒn thá»‹ Modal xÃ¡c nháº­n NGHIÃŠM NGáº¶T:
   âš ï¸ WARNING: HÃ³a Ä‘Æ¡n gá»‘c INV-001 sáº½ Bá»Š Há»¦Y Bá»
   âš ï¸ KhÃ´ng thá»ƒ hoÃ n tÃ¡c
   
   YÃªu cáº§u nháº­p láº¡i sá»‘ hÃ³a Ä‘Æ¡n gá»‘c Ä‘á»ƒ xÃ¡c nháº­n:
   [ Nháº­p INV-001 Ä‘á»ƒ xÃ¡c nháº­n ]
   â”‚
   â”œâ”€ Nháº­p sai â†’ KhÃ´ng cho phÃ¡t hÃ nh
   â”‚
   â””â”€ Nháº­p Ä‘Ãºng â†’ Cho phÃ©p tiáº¿p tá»¥c
       â”‚
       â–¼
9. System gá»i API:
   POST /api/Invoice/replacement
   {
     "originalInvoiceId": 123,
     "reason": "...",
     "customer": { ... },
     "items": [ ... ]
   }
   â”‚
   â–¼
10. Backend xá»­ lÃ½ (TRANSACTION):
    BEGIN TRANSACTION;
    
    â€¢ Táº¡o invoice má»›i vá»›i sá»‘ má»›i
    â€¢ Copy customer, items tá»« request
    â€¢ Set is_replacement = TRUE
    â€¢ Set original_invoice_id = 123
    
    â€¢ Update invoice gá»‘c:
      - status = CANCELLED
      - cancelled_reason = "Replaced by INV-XXX"
      - replaced_by_invoice_id = new_invoice_id
    
    â€¢ Táº¡o record trong invoice_replacements
    â€¢ Ghi audit log
    
    COMMIT;
    â”‚
    â–¼
11. Response:
    â€¢ Status: 200 OK
    â€¢ Data: { 
        newInvoiceId, 
        newInvoiceNumber,
        originalInvoiceId 
      }
    â”‚
    â–¼
12. Frontend:
    â€¢ Hiá»ƒn thá»‹ modal thÃ nh cÃ´ng vá»›i 2 buttons:
      [Xem hÃ³a Ä‘Æ¡n má»›i] [Quay vá» danh sÃ¡ch]
    â€¢ Highlight hÃ³a Ä‘Æ¡n má»›i trong danh sÃ¡ch
```

---

## ğŸ¯ 6. Tá»”NG Káº¾T & PRIORITY

### ğŸš¨ Critical Issues (Fix ngay):

1. **âŒ API Adjustment cÃ³ field `newCustomerId` SAI NGHIá»†P Vá»¤**
   - Priority: **P0 - BLOCKER**
   - Impact: Vi pháº¡m quy Ä‘á»‹nh phÃ¡p luáº­t
   - Action: Loáº¡i bá» field nÃ y ngay láº­p tá»©c

2. **âŒ Thiáº¿u validation hÃ³a Ä‘Æ¡n gá»‘c**
   - Priority: **P0 - BLOCKER**
   - Impact: CÃ³ thá»ƒ Ä‘iá»u chá»‰nh/thay tháº¿ hÃ³a Ä‘Æ¡n khÃ´ng há»£p lá»‡
   - Action: ThÃªm validation á»Ÿ cáº£ frontend vÃ  backend

3. **âŒ KhÃ´ng cÃ³ confirmation modal nghiÃªm ngáº·t**
   - Priority: **P1 - CRITICAL**
   - Impact: User cÃ³ thá»ƒ phÃ¡t hÃ nh nháº§m
   - Action: ThÃªm modal xÃ¡c nháº­n vá»›i checkboxes

---

### âš ï¸ Important Improvements (Cáº§n cÃ³):

4. **Thiáº¿u field `adjustmentType` trong API**
   - Priority: **P1 - CRITICAL**
   - Impact: KhÃ´ng phÃ¢n biá»‡t Ä‘Æ°á»£c tÄƒng/giáº£m
   - Action: ThÃªm vÃ o API request

5. **KhÃ´ng cÃ³ so sÃ¡nh Before/After**
   - Priority: **P2 - HIGH**
   - Impact: User khÃ³ kiá»ƒm tra
   - Action: ThÃªm comparison table

6. **Thiáº¿u file upload giáº£i trÃ¬nh**
   - Priority: **P2 - HIGH**
   - Impact: Thiáº¿u cÄƒn cá»© phÃ¡p lÃ½
   - Action: ThÃªm file upload component

---

### âœ… Nice-to-have Features:

7. **Preview PDF**
8. **Email notification tá»± Ä‘á»™ng**
9. **Audit trail chi tiáº¿t**
10. **Export bÃ¡o cÃ¡o Ä‘iá»u chá»‰nh/thay tháº¿**

---

## ğŸ“Œ 7. ACTION ITEMS

### For Backend Team:

- [ ] **URGENT:** Loáº¡i bá» `newCustomerId` tá»« Adjustment API
- [ ] ThÃªm `adjustmentType` enum vÃ o Adjustment API
- [ ] ThÃªm validation status hÃ³a Ä‘Æ¡n gá»‘c
- [ ] ThÃªm check hÃ³a Ä‘Æ¡n gá»‘c chÆ°a bá»‹ thay tháº¿
- [ ] Bá»• sung thÃ´ng tin khÃ¡ch hÃ ng Ä‘áº§y Ä‘á»§ vÃ o Replacement API
- [ ] Táº¡o database schema cho adjustments/replacements
- [ ] Implement transaction cho replacement (cancel old + create new)
- [ ] ThÃªm audit log chi tiáº¿t

### For Frontend Team:

- [ ] **URGENT:** XÃ³a logic liÃªn quan Ä‘áº¿n `newCustomerId` trong Adjustment UI
- [ ] ThÃªm Adjustment Type Selector (INCREASE/DECREASE)
- [ ] ThÃªm Comparison Table (Before/After/Final)
- [ ] ThÃªm Confirmation Modal vá»›i checkboxes
- [ ] ThÃªm File Upload component
- [ ] Implement Side-by-Side comparison cho Replacement
- [ ] ThÃªm "Copy tá»« gá»‘c" button
- [ ] ThÃªm strict confirmation vá»›i type-to-confirm
- [ ] Improve error handling vÃ  validation messages

### For QA Team:

- [ ] Test case: KhÃ´ng Ä‘Æ°á»£c Ä‘iá»u chá»‰nh hÃ³a Ä‘Æ¡n DRAFT
- [ ] Test case: KhÃ´ng Ä‘Æ°á»£c Ä‘iá»u chá»‰nh hÃ³a Ä‘Æ¡n Ä‘Ã£ thay tháº¿
- [ ] Test case: KhÃ´ng Ä‘Æ°á»£c thay tháº¿ hÃ³a Ä‘Æ¡n Ä‘Ã£ thay tháº¿
- [ ] Test case: Validation file upload
- [ ] Test case: Transaction rollback khi replacement fail
- [ ] Test case: Audit log ghi Ä‘áº§y Ä‘á»§ thÃ´ng tin

---

**Generated by:** Claude Sonnet 4.5  
**Date:** January 2, 2026  
**Version:** 1.0.0
